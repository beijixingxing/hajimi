name: Dockeré•œåƒæ„å»ºåŠä¸Šæ¸¸åŒæ­¥

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©UTCæ—¶é—´3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´11ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  sync-fork:
    name: ä¸Šæ¸¸ä»“åº“åŒæ­¥
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    outputs:
      should_build: ${{ steps.build_control.outputs.should_build }}
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          path: main-repo  # æŒ‡å®šæ£€å‡ºè·¯å¾„

      - name: é…ç½®Gitèº«ä»½
        run: |
          git config user.name "beijixingxing"
          git config user.email "yunxi815@gmail.com"
          echo "âœ… Gitèº«ä»½é…ç½®å®Œæˆ"

      - name: å¤‡ä»½å·¥ä½œæµæ–‡ä»¶
        run: |
          mkdir -p .github/workflows/backup
          cp -v .github/workflows/*.yml .github/workflows/backup/
          echo "ğŸ”„ å·²å¤‡ä»½å·¥ä½œæµæ–‡ä»¶åˆ° .github/workflows/backup"
          ls -l .github/workflows/backup

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        timeout-minutes: 5
        env:
          RETRY_COUNT: 3
        run: |
          cd main-repo  # è¿›å…¥æŒ‡å®šè·¯å¾„
          echo "ğŸ“„ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -l

          # å¸¦é‡è¯•æœºåˆ¶çš„ç‰ˆæœ¬è·å–
          for i in $(seq 1 $RETRY_COUNT); do
            CURRENT_VERSION=$(grep -oP 'version\s*=\s*["\x27]?\K[0-9]+\.[0-9]+\.[0-9]+' version.txt) && break
            sleep 2
            echo "ğŸ”„ é‡è¯•è·å–ç‰ˆæœ¬ ($i/$RETRY_COUNT)..."
          done
          [ -z "$CURRENT_VERSION" ] && { echo "::error::æ— æ³•æå–å½“å‰ç‰ˆæœ¬"; exit 1; }
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # è·å–ä¸Šæ¸¸ç‰ˆæœ¬
          UPSTREAM_RAW=$(curl --retry 3 --max-time 10 -fsSL https://raw.githubusercontent.com/wyeeeee/hajimi/main/version.txt)
          UPSTREAM_VERSION=$(echo "$UPSTREAM_RAW" | grep -oP 'version\s*=\s*["\x27]?\K[0-9]+\.[0-9]+\.[0-9]+')
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ” ç‰ˆæœ¬ä¿¡æ¯è·å–å®Œæˆ"

      - name: ç‰ˆæœ¬æ¯”å¯¹
        run: |
          echo "ğŸ”„ æœ¬åœ°ç‰ˆæœ¬: ${{ steps.current_version.outputs.current_version }}"
          echo "ğŸ†• ä¸Šæ¸¸ç‰ˆæœ¬: ${{ steps.upstream_version.outputs.upstream_version }}"
          if [[ "${{ steps.current_version.outputs.current_version }}" != "${{ steps.upstream_version.outputs.upstream_version }}" ]]; then
            echo "need_sync=true" >> $GITHUB_OUTPUT
            echo "::notice::æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦åŒæ­¥"
          else
            echo "need_sync=false" >> $GITHUB_OUTPUT
            echo "::notice::ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥"
          fi

      - name: æ‰§è¡ŒåŒæ­¥
        if: steps.version_check.outputs.need_sync == 'true'
        run: |
          cd main-repo  # è¿›å…¥æŒ‡å®šè·¯å¾„
          git remote add upstream https://github.com/wyeeeee/hajimi.git || true
          git fetch upstream main --depth=1
          git reset --hard upstream/main
          echo "ğŸ”„ å¼ºåˆ¶åŒæ­¥å®Œæˆ"

      - name: æ¢å¤å·¥ä½œæµé…ç½®
        if: steps.version_check.outputs.need_sync == 'true'
        run: |
          cd main-repo  # è¿›å…¥æŒ‡å®šè·¯å¾„
          cp -v .github/workflows/backup/*.yml .github/workflows/
          git add .github/workflows/
          if ! git commit -m "æ¢å¤è‡ªå®šä¹‰å·¥ä½œæµé…ç½®"; then
            echo "âš ï¸ æ— å·¥ä½œæµæ–‡ä»¶å˜æ›´"
          fi
          git push origin main --force-with-lease
          echo "âœ… å·¥ä½œæµé…ç½®æ¢å¤å®Œæˆ"

      - name: æ„å»ºæ§åˆ¶
        id: build_control
        run: |
          echo "è§¦å‘äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          echo "åŒæ­¥çŠ¶æ€: ${{ steps.version_check.outputs.need_sync }}"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ğŸ¯ æ‰‹åŠ¨è§¦å‘æ„å»º"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ğŸ¯ ä»£ç æ¨é€è§¦å‘æ„å»º"
          elif [[ "${{ github.event_name }}" == "schedule" && "${{ steps.version_check.outputs.need_sync }}" == "true" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ğŸ¯ å®šæ—¶ä»»åŠ¡è§¦å‘æ„å»º"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ ä¸æ»¡è¶³æ„å»ºæ¡ä»¶"
          fi

  build-and-push:
    name: æ„å»ºæ¨é€é•œåƒ
    needs: sync-fork
    runs-on: ubuntu-latest
    if: ${{ needs.sync-fork.outputs.should_build == 'true' }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: è·å–æœ€æ–°ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          path: src
          clean: true
          fetch-depth: 0

      - name: éªŒè¯ç›®å½•ç»“æ„
        run: |
          echo "ğŸ“‚ å·¥ä½œåŒºç›®å½•ç»“æ„ï¼š"
          ls -l
          if [ ! -d "src" ]; then
            echo "::error::srcç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          echo "âœ… ç›®å½•éªŒè¯é€šè¿‡"

      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          cd src || exit 1
          echo "ğŸ“„ version.txtå†…å®¹ï¼š"
          cat version.txt
          
          # æ”¯æŒå¸¦å¼•å·å’Œç©ºæ ¼çš„ç‰ˆæœ¬æ ¼å¼
          RAW_VERSION=$(grep -oP 'version\s*=\s*["\x27]?\K[0-9]+\.[0-9]+\.[0-9]+' version.txt)
          if [ -z "$RAW_VERSION" ]; then
            echo "::error::ç‰ˆæœ¬æå–å¤±è´¥ï¼æ–‡ä»¶å†…å®¹ï¼š"
            cat version.txt
            exit 1
          fi
          
          echo "version=v${RAW_VERSION}" >> $GITHUB_OUTPUT
          echo "raw_version=${RAW_VERSION}" >> $GITHUB_OUTPUT
          echo "ç”Ÿæˆçš„é•œåƒæ ‡ç­¾ï¼šv$RAW_VERSION"

      - name: å‡†å¤‡æ„å»ºä¸Šä¸‹æ–‡
        run: |
          rm -rf docker_build
          mkdir -p docker_build
          echo "ğŸ“¦ æ­£åœ¨å¤åˆ¶æ„å»ºæ–‡ä»¶ï¼š"
          cp -v src/Dockerfile docker_build/
          cp -v src/version.txt docker_build/
          
          if [ -d "src/app" ]; then
            cp -rv src/app docker_build/
            echo "âœ… å·²å¤åˆ¶åº”ç”¨ç›®å½•"
          else
            echo "::warning::æœªæ‰¾åˆ°appç›®å½•"
          fi
          
          if [ -f "src/requirements.txt" ]; then
            cp -v src/requirements.txt docker_build/
          fi
          
          echo "æœ€ç»ˆæ„å»ºä¸Šä¸‹æ–‡ï¼š"
          tree docker_build

      - name: é…ç½®æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          platforms: linux/amd64,linux/arm64

      - name: ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ç”Ÿæˆé•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: beijixingxing/hajimi
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.version }}
          flavor: |
            latest=false

      - name: æ„å»ºæ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: docker_build
          file: docker_build/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true  # ç¦ç”¨ç¼“å­˜
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: é•œåƒéªŒè¯
        timeout-minutes: 5
        run: |
          echo "ğŸ” å¼€å§‹éªŒè¯é•œåƒå†…å®¹..."
          docker pull beijixingxing/hajimi:${{ steps.version.outputs.version }}
          
          echo "é•œåƒå†…ç‰ˆæœ¬æ–‡ä»¶å†…å®¹ï¼š"
          docker run --rm beijixingxing/hajimi:${{ steps.version.outputs.version }} cat /app/version.txt
          
          if ! docker run --rm beijixingxing/hajimi:${{ steps.version.outputs.version }} grep -q "version=${{ steps.version.outputs.raw_version }}" /app/version.txt; then
            echo "::error::é•œåƒç‰ˆæœ¬ä¸åŒ¹é…ï¼"
            exit 1
          fi
          echo "âœ… é•œåƒéªŒè¯é€šè¿‡"

name: Docker镜像构建及上游同步

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-fork:
    name: 上游仓库同步
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    outputs:
      should_build: ${{ steps.build_control.outputs.should_build }}
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 配置Git身份
        run: |
          git config user.name "beijixingxing"
          git config user.email "yunxi815@gmail.com"
          
      - name: 备份工作流文件
        run: |
          mkdir -p /tmp/workflow_backup
          cp -r .github/workflows/* /tmp/workflow_backup/
          echo "工作流文件已备份"

      - name: 读取当前版本
        id: current_version
        run: |
          CURRENT_VERSION=$(grep -oP 'version\s*=\s*["\x27]?\K[^"\x27]*' version.txt)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "当前版本: $CURRENT_VERSION"

      - name: 获取上游版本
        id: upstream_version
        run: |
          UPSTREAM_RAW=$(curl -s https://raw.githubusercontent.com/wyeeeee/hajimi/main/version.txt)
          UPSTREAM_VERSION=$(echo "$UPSTREAM_RAW" | grep -oP 'version\s*=\s*["\x27]?\K[^"\x27]*')
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "上游版本: $UPSTREAM_VERSION"

      - name: 版本比对
        id: version_check
        run: |
          if [ "${{ steps.current_version.outputs.current_version }}" != "${{ steps.upstream_version.outputs.upstream_version }}" ]; then
            echo "::notice::检测到版本变更（本地:${{ steps.current_version.outputs.current_version }} 上游:${{ steps.upstream_version.outputs.upstream_version }}）"
            echo "need_sync=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::版本号相同，无需同步"
            echo "need_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: 配置上游仓库
        if: steps.version_check.outputs.need_sync == 'true'
        run: |
          git remote add upstream https://github.com/wyeeeee/hajimi.git || true
          git fetch upstream

      - name: 强制同步
        if: steps.version_check.outputs.need_sync == 'true'
        run: |
          git reset --hard upstream/main
          echo "已完成代码同步"

      - name: 恢复工作流文件
        if: steps.version_check.outputs.need_sync == 'true'
        run: |
          cp -r /tmp/workflow_backup/* .github/workflows/
          git add .github/workflows/
          git commit -m "恢复工作流文件" || echo "没有工作流文件变更"
          git push origin main --force
          echo "工作流文件已恢复"

      - name: 设置构建控制标志
        id: build_control
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || 
             [ "${{ github.event_name }}" == "push" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "schedule" ] && 
               [ "${{ steps.version_check.outputs.need_sync }}" == "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
          echo "构建标志设置为: ${{ steps.build_control.outputs.should_build }}"

  build-and-push:
    name: 构建推送Docker镜像
    needs: sync-fork
    runs-on: ubuntu-latest
    if: ${{ needs.sync-fork.outputs.should_build == 'true' }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: 获取同步后的代码
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}  # 关键！强制使用最新提交
          path: src
          fetch-depth: 0

      - name: 验证代码版本
        run: |
          cd src
          echo "当前提交ID: $(git rev-parse HEAD)"
          echo "version.txt内容："
          cat version.txt
          if ! grep -q 'version=' version.txt; then
            echo "::error::版本文件格式错误!"
            exit 1
          fi

      - name: 读取版本号
        id: version
        run: |
          cd src
          RAW_VERSION=$(grep -oP 'version\s*=\s*["\x27]?\K[^"\x27]*' version.txt)
          SANITIZED_VERSION=$(echo "$RAW_VERSION" | tr -d '"'"'")
          echo "version=v$SANITIZED_VERSION" >> $GITHUB_OUTPUT
          echo "镜像版本: v$SANITIZED_VERSION"

      - name: 清理构建缓存
        run: |
          rm -rf docker_build
          mkdir -p docker_build

      - name: 准备构建文件
        run: |
          cp -v src/app/* docker_build/
          cp -v src/Dockerfile docker_build/
          cp -v src/requirements.txt docker_build/
          cp -v src/version.txt docker_build/
          echo "构建文件清单："
          ls -l docker_build/

      - name: 配置Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 生成镜像标签
        id: tags
        uses: docker/metadata-action@v5
        with:
          images: beijixingxing/hajimi
          tags: |
            type=raw,value=latest
            type=raw,value=${{ 
              startsWith(github.ref, 'refs/tags/') && github.ref_name 
              || steps.version.outputs.version 
            }}
          flavor: |
            latest=false

      - name: 构建推送镜像
        uses: docker/build-push-action@v5
        with:
          context: docker_build
          file: docker_build/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          labels: ${{ steps.tags.outputs.labels }}
          no-cache: true  # 关键！禁用缓存
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 镜像验证
        run: |
          echo "正在验证镜像内容..."
          docker pull beijixingxing/hajimi:${{ steps.tags.outputs.tags }}
          docker run --rm beijixingxing/hajimi:${{ steps.tags.outputs.tags }} \
            cat /app/version.txt | grep 'version=0.1.3' && echo "版本验证成功" || (echo "::error::镜像内版本不匹配"; exit 1)

      - name: 构建完成通知
        if: ${{ always() }}
        run: |
          echo "Docker镜像构建推送完成"
          echo "标签: ${{ steps.tags.outputs.tags }}"
